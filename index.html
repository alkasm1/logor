<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎨 استوديو التصميم الاحترافي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@300;400;600;700;900&family=Pacifico&family=Tajawal:wght@300;400;500;700;900&family=Scheherazade+New:wght@400;700&family=Reem+Kufi:wght@400;500;600;700&family=Lalezar&family=Markazi+Text:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#6366f1',
                        'secondary': '#8b5cf6',
                        'accent': '#f59e0b',
                        'dark': '#0a0a0a',
                        'card': '#1a1a1a',
                        'border': '#333333'
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%);
            font-family: 'Cairo', sans-serif;
        }
        
        .glass-effect {
            backdrop-filter: blur(15px);
            background: rgba(26, 26, 26, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .canvas-container {
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.6);
            position: relative;
        }
        
        .canvas-container::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 20px;
            padding: 2px;
            background: linear-gradient(45deg, #6366f1, #8b5cf6, #f59e0b);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
        }
        
        .control-panel {
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }
        
        .control-group {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .control-group:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateY(-2px);
            border-color: rgba(99, 102, 241, 0.3);
        }
        
        .tool-button {
            background: linear-gradient(135deg, #2a2a2a, #3a3a3a);
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .tool-button:hover {
            border-color: #6366f1;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }
        
        .tool-button.active {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-color: #f59e0b;
        }
        
        .layer-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .layer-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #6366f1;
        }
        
        .layer-item.active {
            background: rgba(99, 102, 241, 0.2);
            border-color: #6366f1;
        }
        
        .glow-effect {
            filter: drop-shadow(0 0 20px currentColor);
        }
        
        .canvas-tools {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            display: flex;
            gap: 10px;
        }
        
        .canvas-zoom {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 10;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            height: 4px;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #6366f1, #8b5cf6);
            border-radius: 4px;
        }
        
        .crop-area {
            position: absolute;
            border: 2px dashed #6366f1;
            background: rgba(99, 102, 241, 0.1);
            cursor: move;
        }
        
        .crop-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #6366f1;
            border: 2px solid white;
            border-radius: 50%;
            cursor: nwse-resize;
        }
        
        @keyframes pulse-glow {
            0%, 100% { filter: drop-shadow(0 0 5px currentColor); }
            50% { filter: drop-shadow(0 0 25px currentColor); }
        }
        
        .animate-glow {
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        
        .gradient-text {
            background: linear-gradient(45deg, #6366f1, #8b5cf6, #f59e0b);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-shift 3s ease infinite;
        }
        
        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .blend-modes {
            mix-blend-mode: var(--blend-mode, normal);
        }
    </style>
</head>
<body class="bg-dark text-white min-h-screen overflow-hidden">
    
    <!-- Header -->
    <header class="glass-effect py-4 mb-6 relative z-50">
        <div class="container mx-auto px-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-reverse space-x-4">
                    <div class="w-12 h-12 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center animate-float">
                        <i class="fas fa-palette text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold gradient-text">
                            🎨 استوديو التصميم الاحترافي
                        </h1>
                        <p class="text-gray-400 text-sm">أدوات تصميم متقدمة للمحترفين</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-reverse space-x-3">
                    <button onclick="saveProject()" class="tool-button text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-save mr-2"></i>حفظ
                    </button>
                    <button onclick="loadProject()" class="tool-button text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-folder-open mr-2"></i>فتح
                    </button>
                    <button onclick="exportOptions()" class="tool-button text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-download mr-2"></i>تصدير
                    </button>
                    <button onclick="undoAction()" class="tool-button text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-undo mr-2"></i>تراجع
                    </button>
                    <button onclick="redoAction()" class="tool-button text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-redo mr-2"></i>إعادة
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex h-screen">
        
        <!-- Left Panel - Tools -->
        <div class="w-80 control-panel m-4 p-6 custom-scrollbar">
            
            <!-- Tool Selection -->
            <div class="control-group">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-tools text-accent mr-2"></i>أدوات التصميم
                </h3>
                <div class="grid grid-cols-3 gap-3">
                    <button class="tool-button p-3 rounded-lg text-center active" onclick="selectTool('text')" data-tool="text">
                        <i class="fas fa-font text-xl mb-1"></i>
                        <p class="text-xs">نص</p>
                    </button>
                    <button class="tool-button p-3 rounded-lg text-center" onclick="selectTool('brush')" data-tool="brush">
                        <i class="fas fa-paint-brush text-xl mb-1"></i>
                        <p class="text-xs">فرشاة</p>
                    </button>
                    <button class="tool-button p-3 rounded-lg text-center" onclick="selectTool('crop')" data-tool="crop">
                        <i class="fas fa-crop-alt text-xl mb-1"></i>
                        <p class="text-xs">اقتصاص</p>
                    </button>
                    <button class="tool-button p-3 rounded-lg text-center" onclick="selectTool('eraser')" data-tool="eraser">
                        <i class="fas fa-eraser text-xl mb-1"></i>
                        <p class="text-xs">ممحاة</p>
                    </button>
                    <button class="tool-button p-3 rounded-lg text-center" onclick="selectTool('select')" data-tool="select">
                        <i class="fas fa-vector-square text-xl mb-1"></i>
                        <p class="text-xs">تحديد</p>
                    </button>
                    <button class="tool-button p-3 rounded-lg text-center" onclick="selectTool('effects')" data-tool="effects">
                        <i class="fas fa-magic text-xl mb-1"></i>
                        <p class="text-xs">تأثيرات</p>
                    </button>
                </div>
            </div>

            <!-- Text Tools -->
            <div id="textTools" class="control-group">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-font text-accent mr-2"></i>إعدادات النص
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">النص</label>
                        <textarea id="textInput" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg focus:border-primary focus:outline-none resize-none text-base" 
                                  rows="3" placeholder="اكتب نصك هنا..." oninput="updateText()">شعار احترافي</textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium mb-2">الخط</label>
                            <select id="fontFamily" onchange="updateText()" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg focus:border-primary focus:outline-none text-sm">
                                <option value="Cairo">Cairo</option>
                                <option value="Amiri">Amiri</option>
                                <option value="Tajawal">Tajawal</option>
                                <option value="Reem Kufi">Reem Kufi</option>
                                <option value="Lalezar">Lalezar</option>
                                <option value="Pacifico">Pacifico</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">الحجم</label>
                            <input type="range" id="fontSize" min="12" max="200" value="60" class="w-full accent-primary" oninput="updateDisplay(); updateText()" />
                            <span id="fontSizeDisplay" class="text-xs text-gray-400">60px</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-2">
                        <button class="tool-button p-2 rounded" onclick="toggleTextStyle('bold')" data-style="bold">
                            <i class="fas fa-bold"></i>
                        </button>
                        <button class="tool-button p-2 rounded" onclick="toggleTextStyle('italic')" data-style="italic">
                            <i class="fas fa-italic"></i>
                        </button>
                        <button class="tool-button p-2 rounded" onclick="toggleTextStyle('underline')" data-style="underline">
                            <i class="fas fa-underline"></i>
                        </button>
                        <button class="tool-button p-2 rounded" onclick="addTextShadow()">
                            <i class="fas fa-clone"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Effects Panel -->
            <div id="effectsPanel" class="control-group">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-magic text-accent mr-2"></i>التأثيرات المتقدمة
                </h3>
                
                <div class="space-y-4">
                    <!-- Glow Effects -->
                    <div>
                        <label class="block text-sm font-medium mb-2">تأثير التوهج</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <input type="checkbox" id="enableGlow" onchange="updateEffects()" class="mr-2 accent-primary" />
                                <span class="text-sm">تفعيل التوهج</span>
                            </div>
                            <div>
                                <input type="range" id="glowIntensity" min="0" max="50" value="10" class="w-full accent-primary" oninput="updateDisplay(); updateEffects()" />
                                <span id="glowIntensityDisplay" class="text-xs text-gray-400">10px</span>
                            </div>
                        </div>
                        <div class="mt-2">
                            <label class="block text-xs text-gray-400 mb-1">لون التوهج</label>
                            <input type="color" id="glowColor" value="#6366f1" class="w-full h-8 rounded border-0 bg-transparent cursor-pointer" onchange="updateEffects()" />
                        </div>
                    </div>

                    <!-- Advanced Shadows -->
                    <div>
                        <label class="block text-sm font-medium mb-2">ظلال متقدمة</label>
                        <div class="space-y-2">
                            <div class="grid grid-cols-3 gap-2">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">X</label>
                                    <input type="range" id="shadowX" min="-50" max="50" value="5" class="w-full accent-primary" oninput="updateDisplay(); updateEffects()" />
                                    <span id="shadowXDisplay" class="text-xs text-gray-400">5px</span>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Y</label>
                                    <input type="range" id="shadowY" min="-50" max="50" value="5" class="w-full accent-primary" oninput="updateDisplay(); updateEffects()" />
                                    <span id="shadowYDisplay" class="text-xs text-gray-400">5px</span>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">ضبابية</label>
                                    <input type="range" id="shadowBlur" min="0" max="30" value="10" class="w-full accent-primary" oninput="updateDisplay(); updateEffects()" />
                                    <span id="shadowBlurDisplay" class="text-xs text-gray-400">10px</span>
                                </div>
                            </div>
                            <input type="color" id="shadowColor" value="#000000" class="w-full h-8 rounded border-0 bg-transparent cursor-pointer" onchange="updateEffects()" />
                        </div>
                    </div>

                    <!-- Filters -->
                    <div>
                        <label class="block text-sm font-medium mb-2">المرشحات</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">السطوع</label>
                                <input type="range" id="brightness" min="0" max="200" value="100" class="w-full accent-primary" oninput="updateDisplay(); updateEffects()" />
                                <span id="brightnessDisplay" class="text-xs text-gray-400">100%</span>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">التباين</label>
                                <input type="range" id="contrast" min="0" max="200" value="100" class="w-full accent-primary" oninput="updateDisplay(); updateEffects()" />
                                <span id="contrastDisplay" class="text-xs text-gray-400">100%</span>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">التشبع</label>
                                <input type="range" id="saturate" min="0" max="200" value="100" class="w-full accent-primary" oninput="updateDisplay(); updateEffects()" />
                                <span id="saturateDisplay" class="text-xs text-gray-400">100%</span>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">الدوران اللوني</label>
                                <input type="range" id="hueRotate" min="0" max="360" value="0" class="w-full accent-primary" oninput="updateDisplay(); updateEffects()" />
                                <span id="hueRotateDisplay" class="text-xs text-gray-400">0°</span>
                            </div>
                        </div>
                    </div>

                    <!-- Blend Modes -->
                    <div>
                        <label class="block text-sm font-medium mb-2">أنماط المزج</label>
                        <select id="blendMode" onchange="updateEffects()" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg focus:border-primary focus:outline-none text-sm">
                            <option value="normal">عادي</option>
                            <option value="multiply">ضرب</option>
                            <option value="screen">شاشة</option>
                            <option value="overlay">تراكب</option>
                            <option value="soft-light">ضوء ناعم</option>
                            <option value="hard-light">ضوء قاسي</option>
                            <option value="color-dodge">تفادي اللون</option>
                            <option value="color-burn">حرق اللون</option>
                            <option value="difference">اختلاف</option>
                            <option value="exclusion">استبعاد</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Layers Panel -->
            <div class="control-group">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-layer-group text-accent mr-2"></i>الطبقات
                </h3>
                <div class="space-y-2" id="layersContainer">
                    <!-- Layers will be added dynamically -->
                </div>
                <button onclick="addNewLayer()" class="w-full bg-primary hover:bg-blue-700 text-white py-2 rounded-lg mt-3">
                    <i class="fas fa-plus mr-2"></i>إضافة طبقة
                </button>
            </div>

            <!-- Background Removal -->
            <div class="control-group">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-cut text-accent mr-2"></i>إزالة الخلفية
                </h3>
                <div class="space-y-3">
                    <input type="file" id="bgRemovalInput" accept="image/*" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-sm" />
                    <button onclick="removeBackground()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg">
                        <i class="fas fa-scissors mr-2"></i>إزالة الخلفية
                    </button>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="selectBackground()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-sm">
                            <i class="fas fa-mouse-pointer mr-1"></i>تحديد
                        </button>
                        <button onclick="smartSelect()" class="bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg text-sm">
                            <i class="fas fa-brain mr-1"></i>ذكي
                        </button>
                    </div>
                </div>
            </div>

            <!-- Image Merger -->
            <div class="control-group">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-object-group text-accent mr-2"></i>دمج الصور
                </h3>
                <div class="space-y-3">
                    <input type="file" id="mergeImages" multiple accept="image/*" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-sm" />
                    <button onclick="mergeSelectedImages()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg">
                        <i class="fas fa-compress-arrows-alt mr-2"></i>دمج الصور
                    </button>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setMergeMode('horizontal')" class="bg-gray-600 hover:bg-gray-700 text-white py-1 rounded text-xs">أفقي</button>
                        <button onclick="setMergeMode('vertical')" class="bg-gray-600 hover:bg-gray-700 text-white py-1 rounded text-xs">عمودي</button>
                        <button onclick="setMergeMode('grid')" class="bg-gray-600 hover:bg-gray-700 text-white py-1 rounded text-xs">شبكة</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center Panel - Canvas -->
        <div class="flex-1 flex flex-col p-4">
            <div class="canvas-container flex-1 relative">
                <!-- Canvas Tools -->
                <div class="canvas-tools">
                    <button class="tool-button p-2 rounded-lg" onclick="zoomIn()">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <button class="tool-button p-2 rounded-lg" onclick="zoomOut()">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button class="tool-button p-2 rounded-lg" onclick="resetZoom()">
                        <i class="fas fa-expand-arrows-alt"></i>
                    </button>
                    <button class="tool-button p-2 rounded-lg" onclick="toggleGrid()">
                        <i class="fas fa-th"></i>
                    </button>
                    <button class="tool-button p-2 rounded-lg" onclick="toggleRulers()">
                        <i class="fas fa-ruler-combined"></i>
                    </button>
                </div>

                <!-- Canvas Zoom Info -->
                <div class="canvas-zoom">
                    <div class="glass-effect px-3 py-2 rounded-lg text-sm">
                        <span id="zoomLevel">100%</span>
                    </div>
                </div>

                <!-- Main Canvas -->
                <div class="flex items-center justify-center h-full">
                    <div id="canvasWrapper" class="relative">
                        <canvas id="mainCanvas" width="800" height="600" 
                                class="border-2 border-gray-600 rounded-lg shadow-2xl bg-white cursor-crosshair"
                                onmousedown="startDrawing(event)"
                                onmousemove="draw(event)"
                                onmouseup="stopDrawing()"
                                onmouseleave="stopDrawing()"></canvas>
                        
                        <!-- Crop Area (hidden by default) -->
                        <div id="cropArea" class="crop-area hidden">
                            <div class="crop-handle" style="top: -5px; left: -5px;"></div>
                            <div class="crop-handle" style="top: -5px; right: -5px;"></div>
                            <div class="crop-handle" style="bottom: -5px; left: -5px;"></div>
                            <div class="crop-handle" style="bottom: -5px; right: -5px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Tools -->
            <div class="mt-6">
                <div class="glass-effect p-4 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-reverse space-x-4">
                            <!-- Color Palette -->
                            <div class="flex items-center space-x-reverse space-x-2">
                                <label class="text-sm font-medium">اللون:</label>
                                <input type="color" id="primaryColor" value="#6366f1" class="w-10 h-10 rounded border-2 border-gray-600 bg-transparent cursor-pointer" onchange="updateColor()" />
                                <input type="color" id="secondaryColor" value="#8b5cf6" class="w-10 h-10 rounded border-2 border-gray-600 bg-transparent cursor-pointer" onchange="updateColor()" />
                            </div>

                            <!-- Brush Size -->
                            <div class="flex items-center space-x-reverse space-x-2">
                                <label class="text-sm font-medium">الفرشاة:</label>
                                <input type="range" id="brushSize" min="1" max="50" value="5" class="accent-primary" oninput="updateDisplay(); updateBrush()" />
                                <span id="brushSizeDisplay" class="text-xs text-gray-400 w-8">5px</span>
                            </div>

                            <!-- Opacity -->
                            <div class="flex items-center space-x-reverse space-x-2">
                                <label class="text-sm font-medium">الشفافية:</label>
                                <input type="range" id="opacity" min="0" max="100" value="100" class="accent-primary" oninput="updateDisplay(); updateOpacity()" />
                                <span id="opacityDisplay" class="text-xs text-gray-400 w-12">100%</span>
                            </div>
                        </div>

                        <div class="flex space-x-reverse space-x-3">
                            <button onclick="clearCanvas()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-trash mr-2"></i>مسح
                            </button>
                            <button onclick="duplicateCanvas()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-copy mr-2"></i>نسخ
                            </button>
                            <button onclick="flipHorizontal()" class="tool-button text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-arrows-alt-h mr-2"></i>قلب أفقي
                            </button>
                            <button onclick="flipVertical()" class="tool-button text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-arrows-alt-v mr-2"></i>قلب عمودي
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Advanced Options -->
        <div class="w-80 control-panel m-4 p-6 custom-scrollbar">
            
            <!-- Color Gradients -->
            <div class="control-group">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-palette text-accent mr-2"></i>التدرجات اللونية
                </h3>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="gradient-preview bg-gradient-to-r from-blue-500 to-purple-600" onclick="applyGradient('blue-purple')"></div>
                        <div class="gradient-preview bg-gradient-to-r from-pink-500 to-orange-500" onclick="applyGradient('pink-orange')"></div>
                        <div class="gradient-preview bg-gradient-to-r from-green-400 to-blue-600" onclick="applyGradient('green-blue')"></div>
                        <div class="gradient-preview bg-gradient-to-r from-purple-600 to-pink-600" onclick="applyGradient('purple-pink')"></div>
                    </div>
                    
                    <div class="space-y-2">
                        <label class="block text-sm font-medium">تدرج مخصص</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="color" id="gradStart" value="#6366f1" class="w-full h-8 rounded border-0 bg-transparent cursor-pointer" />
                            <input type="color" id="gradEnd" value="#8b5cf6" class="w-full h-8 rounded border-0 bg-transparent cursor-pointer" />
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">الاتجاه</label>
                            <input type="range" id="gradAngle" min="0" max="360" value="45" class="w-full accent-primary" oninput="updateDisplay()" />
                            <span id="gradAngleDisplay" class="text-xs text-gray-400">45°</span>
                        </div>
                        <button onclick="applyCustomGradient()" class="w-full bg-gradient-to-r from-primary to-secondary text-white py-2 rounded-lg">
                            تطبيق التدرج
                        </button>
                    </div>
                </div>
            </div>

            <!-- Animation -->
            <div class="control-group">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-play text-accent mr-2"></i>الحركة والأنيميشن
                </h3>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="animateRotate()" class="tool-button text-white py-2 rounded-lg text-sm">
                            <i class="fas fa-sync-alt mb-1"></i><br>دوران
                        </button>
                        <button onclick="animateScale()" class="tool-button text-white py-2 rounded-lg text-sm">
                            <i class="fas fa-expand-arrows-alt mb-1"></i><br>تكبير
                        </button>
                        <button onclick="animateFade()" class="tool-button text-white py-2 rounded-lg text-sm">
                            <i class="fas fa-eye mb-1"></i><br>اختفاء
                        </button>
                        <button onclick="animateGlow()" class="tool-button text-white py-2 rounded-lg text-sm">
                            <i class="fas fa-star mb-1"></i><br>توهج
                        </button>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">سرعة الحركة</label>
                        <input type="range" id="animSpeed" min="0.5" max="5" step="0.5" value="2" class="w-full accent-primary" oninput="updateDisplay()" />
                        <span id="animSpeedDisplay" class="text-xs text-gray-400">2x</span>
                    </div>
                    
                    <button onclick="stopAllAnimations()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg">
                        <i class="fas fa-stop mr-2"></i>إيقاف الحركة
                    </button>
                </div>
            </div>

            <!-- Export Settings -->
            <div class="control-group">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-download text-accent mr-2"></i>إعدادات التصدير
                </h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium mb-2">الصيغة</label>
                        <select id="exportFormat" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg focus:border-primary focus:outline-none text-sm">
                            <option value="png">PNG (شفاف)</option>
                            <option value="jpg">JPG (مضغوط)</option>
                            <option value="svg">SVG (متجه)</option>
                            <option value="pdf">PDF (طباعة)</option>
                            <option value="webp">WebP (ويب)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">الجودة</label>
                        <input type="range" id="exportQuality" min="1" max="100" value="90" class="w-full accent-primary" oninput="updateDisplay()" />
                        <span id="exportQualityDisplay" class="text-xs text-gray-400">90%</span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium mb-2">العرض</label>
                            <input type="number" id="exportWidth" value="800" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg focus:border-primary focus:outline-none text-sm" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">الارتفاع</label>
                            <input type="number" id="exportHeight" value="600" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg focus:border-primary focus:outline-none text-sm" />
                        </div>
                    </div>
                    
                    <button onclick="exportCanvas()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-medium">
                        <i class="fas fa-download mr-2"></i>تصدير العمل
                    </button>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="control-group">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-bolt text-accent mr-2"></i>إجراءات سريعة
                </h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="randomizeAll()" class="tool-button text-white py-3 rounded-lg text-sm">
                        <i class="fas fa-random mb-1"></i><br>عشوائي
                    </button>
                    <button onclick="autoEnhance()" class="tool-button text-white py-3 rounded-lg text-sm">
                        <i class="fas fa-magic mb-1"></i><br>تحسين تلقائي
                    </button>
                    <button onclick="addWatermark()" class="tool-button text-white py-3 rounded-lg text-sm">
                        <i class="fas fa-signature mb-1"></i><br>علامة مائية
                    </button>
                    <button onclick="generateQR()" class="tool-button text-white py-3 rounded-lg text-sm">
                        <i class="fas fa-qrcode mb-1"></i><br>QR كود
                    </button>
                    <button onclick="applyVintage()" class="tool-button text-white py-3 rounded-lg text-sm">
                        <i class="fas fa-camera-retro mb-1"></i><br>قديم
                    </button>
                    <button onclick="makeNeon()" class="tool-button text-white py-3 rounded-lg text-sm">
                        <i class="fas fa-lightbulb mb-1"></i><br>نيون
                    </button>
                </div>
            </div>

            <!-- Project Info -->
            <div class="control-group">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-info-circle text-accent mr-2"></i>معلومات المشروع
                </h3>
                <div class="space-y-2 text-sm text-gray-300">
                    <div class="flex justify-between">
                        <span>الأبعاد:</span>
                        <span id="canvasSize">800 × 600</span>
                    </div>
                    <div class="flex justify-between">
                        <span>عدد الطبقات:</span>
                        <span id="layerCount">1</span>
                    </div>
                    <div class="flex justify-between">
                        <span>حجم الملف:</span>
                        <span id="fileSize">~2.1 MB</span>
                    </div>
                    <div class="flex justify-between">
                        <span>التكبير:</span>
                        <span id="currentZoom">100%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-white text-lg">جاري المعالجة...</p>
            <div class="w-64 bg-gray-700 rounded-full h-2 mt-4">
                <div id="progressBar" class="progress-bar h-2 rounded-full" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Hidden Inputs -->
    <input type="file" id="projectFileInput" accept=".json" style="display: none;" onchange="handleProjectLoad()" />

    <script>
        // Global Variables
        let canvas, ctx;
        let currentTool = 'text';
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let currentZoom = 1;
        let layers = [];
        let currentLayer = 0;
        let undoStack = [];
        let redoStack = [];
        let animationIds = [];
        let textElements = [];
        let cropMode = false;
        let mergeMode = 'horizontal';

        // Initialize
        window.onload = function() {
            canvas = document.getElementById('mainCanvas');
            ctx = canvas.getContext('2d');
            
            initializeLayers();
            updateDisplay();
            drawCanvas();
            
            // Setup event listeners
            setupEventListeners();
        };

        function initializeLayers() {
            layers = [{
                id: 'layer1',
                name: 'الطبقة الأساسية',
                visible: true,
                opacity: 1,
                data: ctx.createImageData(canvas.width, canvas.height)
            }];
            updateLayersPanel();
        }

        function updateDisplay() {
            // Update all display spans
            document.getElementById('fontSizeDisplay').textContent = document.getElementById('fontSize').value + 'px';
            document.getElementById('glowIntensityDisplay').textContent = document.getElementById('glowIntensity').value + 'px';
            document.getElementById('shadowXDisplay').textContent = document.getElementById('shadowX').value + 'px';
            document.getElementById('shadowYDisplay').textContent = document.getElementById('shadowY').value + 'px';
            document.getElementById('shadowBlurDisplay').textContent = document.getElementById('shadowBlur').value + 'px';
            document.getElementById('brightnessDisplay').textContent = document.getElementById('brightness').value + '%';
            document.getElementById('contrastDisplay').textContent = document.getElementById('contrast').value + '%';
            document.getElementById('saturateDisplay').textContent = document.getElementById('saturate').value + '%';
            document.getElementById('hueRotateDisplay').textContent = document.getElementById('hueRotate').value + '°';
            document.getElementById('brushSizeDisplay').textContent = document.getElementById('brushSize').value + 'px';
            document.getElementById('opacityDisplay').textContent = document.getElementById('opacity').value + '%';
            document.getElementById('gradAngleDisplay').textContent = document.getElementById('gradAngle').value + '°';
            document.getElementById('animSpeedDisplay').textContent = document.getElementById('animSpeed').value + 'x';
            document.getElementById('exportQualityDisplay').textContent = document.getElementById('exportQuality').value + '%';
            
            // Update project info
            document.getElementById('canvasSize').textContent = canvas.width + ' × ' + canvas.height;
            document.getElementById('layerCount').textContent = layers.length;
            document.getElementById('currentZoom').textContent = Math.round(currentZoom * 100) + '%';
            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
        }

        function selectTool(tool) {
            currentTool = tool;
            
            // Update tool buttons
            document.querySelectorAll('.tool-button[data-tool]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
            
            // Update cursor
            const cursor = {
                'text': 'text',
                'brush': 'crosshair',
                'crop': 'crosshair',
                'eraser': 'cell',
                'select': 'default',
                'effects': 'pointer'
            };
            canvas.style.cursor = cursor[tool] || 'default';
            
            // Show/hide crop area
            if (tool === 'crop') {
                document.getElementById('cropArea').classList.remove('hidden');
                setupCropArea();
            } else {
                document.getElementById('cropArea').classList.add('hidden');
            }
        }

        function updateText() {
            if (currentTool !== 'text') return;
            
            const text = document.getElementById('textInput').value;
            const font = document.getElementById('fontFamily').value;
            const size = document.getElementById('fontSize').value;
            
            // Clear and redraw
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Apply text styles
            ctx.font = `${size}px "${font}"`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Apply effects
            applyTextEffects();
            
            // Draw text
            ctx.fillText(text, canvas.width/2, canvas.height/2);
            
            saveState();
        }

        function applyTextEffects() {
            const enableGlow = document.getElementById('enableGlow').checked;
            const glowIntensity = document.getElementById('glowIntensity').value;
            const glowColor = document.getElementById('glowColor').value;
            const shadowX = document.getElementById('shadowX').value;
            const shadowY = document.getElementById('shadowY').value;
            const shadowBlur = document.getElementById('shadowBlur').value;
            const shadowColor = document.getElementById('shadowColor').value;
            const brightness = document.getElementById('brightness').value;
            const contrast = document.getElementById('contrast').value;
            const saturate = document.getElementById('saturate').value;
            const hueRotate = document.getElementById('hueRotate').value;
            const blendMode = document.getElementById('blendMode').value;
            
            // Apply glow effect
            if (enableGlow) {
                ctx.shadowColor = glowColor;
                ctx.shadowBlur = glowIntensity;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
            }
            
            // Apply shadow
            ctx.shadowOffsetX = shadowX;
            ctx.shadowOffsetY = shadowY;
            ctx.shadowBlur = shadowBlur;
            ctx.shadowColor = shadowColor;
            
            // Apply filters
            ctx.filter = `
                brightness(${brightness}%) 
                contrast(${contrast}%) 
                saturate(${saturate}%) 
                hue-rotate(${hueRotate}deg)
            `;
            
            // Apply blend mode
            ctx.globalCompositeOperation = blendMode;
            
            // Apply color
            const primaryColor = document.getElementById('primaryColor').value;
            ctx.fillStyle = primaryColor;
        }

        function updateEffects() {
            updateText();
        }

        function startDrawing(e) {
            if (currentTool !== 'brush' && currentTool !== 'eraser') return;
            
            isDrawing = true;
            [lastX, lastY] = getMousePos(e);
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
        }

        function draw(e) {
            if (!isDrawing || (currentTool !== 'brush' && currentTool !== 'eraser')) return;
            
            const [currentX, currentY] = getMousePos(e);
            
            ctx.lineWidth = document.getElementById('brushSize').value;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            if (currentTool === 'brush') {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = document.getElementById('primaryColor').value;
            } else if (currentTool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
            }
            
            ctx.lineTo(currentX, currentY);
            ctx.stroke();
            
            [lastX, lastY] = [currentX, currentY];
        }

        function stopDrawing() {
            if (!isDrawing) return;
            isDrawing = false;
            saveState();
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return [
                (e.clientX - rect.left) / currentZoom,
                (e.clientY - rect.top) / currentZoom
            ];
        }

        function setupEventListeners() {
            // Background removal
            document.getElementById('bgRemovalInput').addEventListener('change', handleBgRemovalUpload);
            
            // Image merger
            document.getElementById('mergeImages').addEventListener('change', handleImageMerge);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboard);
        }

        function handleKeyboard(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'z':
                        e.preventDefault();
                        if (e.shiftKey) {
                            redoAction();
                        } else {
                            undoAction();
                        }
                        break;
                    case 's':
                        e.preventDefault();
                        saveProject();
                        break;
                    case 'o':
                        e.preventDefault();
                        loadProject();
                        break;
                }
            }
        }

        function saveState() {
            undoStack.push(canvas.toDataURL());
            if (undoStack.length > 50) {
                undoStack.shift();
            }
            redoStack = [];
        }

        function undoAction() {
            if (undoStack.length > 0) {
                redoStack.push(canvas.toDataURL());
                const previousState = undoStack.pop();
                const img = new Image();
                img.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
                img.src = previousState;
            }
        }

        function redoAction() {
            if (redoStack.length > 0) {
                undoStack.push(canvas.toDataURL());
                const nextState = redoStack.pop();
                const img = new Image();
                img.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
                img.src = nextState;
            }
        }

        function drawCanvas() {
            // Main drawing function - redraws entire canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw each layer
            layers.forEach((layer, index) => {
                if (layer.visible) {
                    ctx.globalAlpha = layer.opacity;
                    // Draw layer content here
                    ctx.globalAlpha = 1;
                }
            });
        }

        function addNewLayer() {
            const newLayer = {
                id: `layer${layers.length + 1}`,
                name: `طبقة ${layers.length + 1}`,
                visible: true,
                opacity: 1,
                data: ctx.createImageData(canvas.width, canvas.height)
            };
            
            layers.push(newLayer);
            currentLayer = layers.length - 1;
            updateLayersPanel();
        }

        function updateLayersPanel() {
            const container = document.getElementById('layersContainer');
            container.innerHTML = '';
            
            layers.forEach((layer, index) => {
                const layerDiv = document.createElement('div');
                layerDiv.className = `layer-item ${index === currentLayer ? 'active' : ''}`;
                layerDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <input type="checkbox" ${layer.visible ? 'checked' : ''} 
                                   onchange="toggleLayerVisibility(${index})" class="mr-2 accent-primary" />
                            <span class="text-sm">${layer.name}</span>
                        </div>
                        <div class="flex space-x-reverse space-x-2">
                            <button onclick="duplicateLayer(${index})" class="text-xs text-blue-400 hover:text-blue-300">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button onclick="deleteLayer(${index})" class="text-xs text-red-400 hover:text-red-300">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <input type="range" min="0" max="1" step="0.1" value="${layer.opacity}"
                               class="w-full accent-primary" onchange="updateLayerOpacity(${index}, this.value)" />
                    </div>
                `;
                
                layerDiv.onclick = () => selectLayer(index);
                container.appendChild(layerDiv);
            });
        }

        function selectLayer(index) {
            currentLayer = index;
            updateLayersPanel();
        }

        function toggleLayerVisibility(index) {
            layers[index].visible = !layers[index].visible;
            drawCanvas();
        }

        function updateLayerOpacity(index, opacity) {
            layers[index].opacity = parseFloat(opacity);
            drawCanvas();
        }

        function duplicateLayer(index) {
            const layer = layers[index];
            const newLayer = {
                ...layer,
                id: `layer${layers.length + 1}`,
                name: `${layer.name} - نسخة`
            };
            layers.splice(index + 1, 0, newLayer);
            updateLayersPanel();
        }

        function deleteLayer(index) {
            if (layers.length > 1) {
                layers.splice(index, 1);
                if (currentLayer >= layers.length) {
                    currentLayer = layers.length - 1;
                }
                updateLayersPanel();
            }
        }

        // Zoom functions
        function zoomIn() {
            currentZoom = Math.min(currentZoom * 1.2, 5);
            applyZoom();
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom / 1.2, 0.1);
            applyZoom();
        }

        function resetZoom() {
            currentZoom = 1;
            applyZoom();
        }

        function applyZoom() {
            const wrapper = document.getElementById('canvasWrapper');
            wrapper.style.transform = `scale(${currentZoom})`;
            updateDisplay();
        }

        // Background removal functions
        function handleBgRemovalUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    // Draw image to canvas for processing
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    showNotification('تم تحميل الصورة، يمكنك الآن إزالة الخلفية', 'success');
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function removeBackground() {
            showLoading();
            
            // Simulate background removal process
            setTimeout(() => {
                // Simple background removal (edge detection)
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // Apply basic edge detection and background removal
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    // Simple background detection (white/light colors)
                    if (r > 240 && g > 240 && b > 240) {
                        data[i + 3] = 0; // Make transparent
                    }
                }
                
                ctx.putImageData(imageData, 0, 0);
                hideLoading();
                showNotification('تم إزالة الخلفية بنجاح!', 'success');
                saveState();
            }, 2000);
        }

        function selectBackground() {
            // Implement smart selection tool
            canvas.style.cursor = 'crosshair';
            showNotification('انقر على المنطقة التي تريد تحديدها', 'info');
        }

        function smartSelect() {
            // Implement AI-powered selection
            showNotification('جاري التحديد الذكي...', 'info');
            // Add AI selection logic here
        }

        // Image merger functions
        function handleImageMerge(e) {
            const files = Array.from(e.target.files);
            if (files.length < 2) {
                showNotification('يرجى اختيار صورتين على الأقل للدمج', 'warning');
                return;
            }
            
            showNotification(`تم اختيار ${files.length} صور للدمج`, 'success');
        }

        function setMergeMode(mode) {
            mergeMode = mode;
            document.querySelectorAll('[onclick^="setMergeMode"]').forEach(btn => {
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-gray-600');
            });
            event.target.classList.remove('bg-gray-600');
            event.target.classList.add('bg-blue-600');
        }

        function mergeSelectedImages() {
            const files = document.getElementById('mergeImages').files;
            if (files.length < 2) {
                showNotification('يرجى اختيار صورتين على الأقل', 'warning');
                return;
            }
            
            showLoading();
            
            const images = [];
            let loadedCount = 0;
            
            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        images[index] = img;
                        loadedCount++;
                        
                        updateProgress((loadedCount / files.length) * 50);
                        
                        if (loadedCount === files.length) {
                            performMerge(images);
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function performMerge(images) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const totalImages = images.length;
            let cols, rows;
            
            switch(mergeMode) {
                case 'horizontal':
                    cols = totalImages;
                    rows = 1;
                    break;
                case 'vertical':
                    cols = 1;
                    rows = totalImages;
                    break;
                case 'grid':
                    cols = Math.ceil(Math.sqrt(totalImages));
                    rows = Math.ceil(totalImages / cols);
                    break;
            }
            
            const cellWidth = canvas.width / cols;
            const cellHeight = canvas.height / rows;
            
            images.forEach((img, index) => {
                const col = index % cols;
                const row = Math.floor(index / cols);
                
                const x = col * cellWidth;
                const y = row * cellHeight;
                
                ctx.drawImage(img, x, y, cellWidth, cellHeight);
                
                updateProgress(50 + ((index + 1) / totalImages) * 50);
            });
            
            setTimeout(() => {
                hideLoading();
                showNotification('تم دمج الصور بنجاح!', 'success');
                saveState();
            }, 500);
        }

        // Animation functions
        function animateRotate() {
            let angle = 0;
            const speed = parseFloat(document.getElementById('animSpeed').value);
            
            function rotate() {
                ctx.save();
                ctx.translate(canvas.width/2, canvas.height/2);
                ctx.rotate((angle * Math.PI) / 180);
                ctx.translate(-canvas.width/2, -canvas.height/2);
                
                drawCanvas();
                
                ctx.restore();
                
                angle += speed;
                const animId = requestAnimationFrame(rotate);
                animationIds.push(animId);
            }
            
            rotate();
        }

        function animateScale() {
            let scale = 1;
            let direction = 1;
            const speed = parseFloat(document.getElementById('animSpeed').value) * 0.01;
            
            function scaleAnimation() {
                ctx.save();
                ctx.translate(canvas.width/2, canvas.height/2);
                ctx.scale(scale, scale);
                ctx.translate(-canvas.width/2, -canvas.height/2);
                
                drawCanvas();
                
                ctx.restore();
                
                scale += direction * speed;
                if (scale > 1.5 || scale < 0.5) direction *= -1;
                
                const animId = requestAnimationFrame(scaleAnimation);
                animationIds.push(animId);
            }
            
            scaleAnimation();
        }

        function animateFade() {
            let alpha = 1;
            let direction = -1;
            const speed = parseFloat(document.getElementById('animSpeed').value) * 0.02;
            
            function fadeAnimation() {
                ctx.globalAlpha = alpha;
                drawCanvas();
                ctx.globalAlpha = 1;
                
                alpha += direction * speed;
                if (alpha > 1 || alpha < 0.3) direction *= -1;
                
                const animId = requestAnimationFrame(fadeAnimation);
                animationIds.push(animId);
            }
            
            fadeAnimation();
        }

        function animateGlow() {
            let glowSize = 0;
            let direction = 1;
            const speed = parseFloat(document.getElementById('animSpeed').value);
            
            function glowAnimation() {
                ctx.shadowColor = document.getElementById('glowColor').value;
                ctx.shadowBlur = glowSize;
                
                drawCanvas();
                
                ctx.shadowBlur = 0;
                
                glowSize += direction * speed;
                if (glowSize > 30 || glowSize < 0) direction *= -1;
                
                const animId = requestAnimationFrame(glowAnimation);
                animationIds.push(animId);
            }
            
            glowAnimation();
        }

        function stopAllAnimations() {
            animationIds.forEach(id => cancelAnimationFrame(id));
            animationIds = [];
            drawCanvas();
            showNotification('تم إيقاف جميع الحركات', 'info');
        }

        // Quick actions
        function randomizeAll() {
            // Randomize colors
            const colors = ['#ef4444', '#f59e0b', '#10b981', '#06b6d4', '#6366f1', '#8b5cf6', '#ec4899'];
            document.getElementById('primaryColor').value = colors[Math.floor(Math.random() * colors.length)];
            document.getElementById('secondaryColor').value = colors[Math.floor(Math.random() * colors.length)];
            
            // Randomize font
            const fonts = ['Cairo', 'Amiri', 'Tajawal', 'Reem Kufi', 'Lalezar'];
            document.getElementById('fontFamily').value = fonts[Math.floor(Math.random() * fonts.length)];
            
            // Randomize size
            document.getElementById('fontSize').value = Math.floor(Math.random() * 100) + 50;
            
            updateText();
            updateDisplay();
            showNotification('تم تطبيق التصميم العشوائي!', 'success');
        }

        function autoEnhance() {
            showLoading();
            
            setTimeout(() => {
                // Apply auto enhancement
                document.getElementById('brightness').value = 110;
                document.getElementById('contrast').value = 120;
                document.getElementById('saturate').value = 110;
                document.getElementById('enableGlow').checked = true;
                document.getElementById('glowIntensity').value = 15;
                
                updateEffects();
                updateDisplay();
                hideLoading();
                showNotification('تم تحسين التصميم تلقائياً!', 'success');
            }, 1500);
        }

        function addWatermark() {
            const text = prompt('أدخل نص العلامة المائية:');
            if (!text) return;
            
            ctx.save();
            ctx.globalAlpha = 0.3;
            ctx.font = '24px Cairo';
            ctx.fillStyle = '#888888';
            ctx.textAlign = 'right';
            ctx.fillText(text, canvas.width - 20, canvas.height - 20);
            ctx.restore();
            
            saveState();
            showNotification('تم إضافة العلامة المائية', 'success');
        }

        function generateQR() {
            const text = document.getElementById('textInput').value || 'شعار احترافي';
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(text)}`;
            
            const img = new Image();
            img.onload = function() {
                ctx.drawImage(img, canvas.width - 120, 20, 100, 100);
                saveState();
                showNotification('تم إضافة QR Code', 'success');
            };
            img.src = qrUrl;
        }

        function applyVintage() {
            // Apply vintage filter
            document.getElementById('brightness').value = 90;
            document.getElementById('contrast').value = 110;
            document.getElementById('saturate').value = 80;
            document.getElementById('hueRotate').value = 20;
            
            updateEffects();
            updateDisplay();
            showNotification('تم تطبيق التأثير القديم', 'success');
        }

        function makeNeon() {
            // Apply neon effect
            document.getElementById('enableGlow').checked = true;
            document.getElementById('glowIntensity').value = 25;
            document.getElementById('glowColor').value = '#00ffff';
            document.getElementById('primaryColor').value = '#ffffff';
            
            updateEffects();
            updateDisplay();
            showNotification('تم تطبيق تأثير النيون', 'success');
        }

        // Gradient functions
        function applyGradient(type) {
            const gradients = {
                'blue-purple': ['#6366f1', '#8b5cf6'],
                'pink-orange': ['#ec4899', '#f59e0b'],
                'green-blue': ['#10b981', '#06b6d4'],
                'purple-pink': ['#8b5cf6', '#ec4899']
            };
            
            if (gradients[type]) {
                document.getElementById('gradStart').value = gradients[type][0];
                document.getElementById('gradEnd').value = gradients[type][1];
                applyCustomGradient();
            }
        }

        function applyCustomGradient() {
            const start = document.getElementById('gradStart').value;
            const end = document.getElementById('gradEnd').value;
            const angle = document.getElementById('gradAngle').value;
            
            // Apply gradient to text
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, start);
            gradient.addColorStop(1, end);
            
            document.getElementById('primaryColor').value = start;
            updateText();
            showNotification('تم تطبيق التدرج اللوني', 'success');
        }

        // Canvas manipulation
        function clearCanvas() {
            if (showConfirmDialog('هل أنت متأكد من مسح اللوحة؟', () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                saveState();
                showNotification('تم مسح اللوحة', 'info');
            })) {
                // Confirmation handled in callback
            }
        }

        function duplicateCanvas() {
            const dataURL = canvas.toDataURL();
            showNotification('تم نسخ اللوحة للحافظة', 'success');
            
            // Copy to clipboard if supported
            if (navigator.clipboard) {
                canvas.toBlob(blob => {
                    navigator.clipboard.write([
                        new ClipboardItem({ 'image/png': blob })
                    ]);
                });
            }
        }

        function flipHorizontal() {
            ctx.save();
            ctx.scale(-1, 1);
            ctx.drawImage(canvas, -canvas.width, 0);
            ctx.restore();
            saveState();
            showNotification('تم قلب اللوحة أفقياً', 'success');
        }

        function flipVertical() {
            ctx.save();
            ctx.scale(1, -1);
            ctx.drawImage(canvas, 0, -canvas.height);
            ctx.restore();
            saveState();
            showNotification('تم قلب اللوحة عمودياً', 'success');
        }

        // Export functions
        function exportCanvas() {
            const format = document.getElementById('exportFormat').value;
            const quality = document.getElementById('exportQuality').value / 100;
            const width = parseInt(document.getElementById('exportWidth').value);
            const height = parseInt(document.getElementById('exportHeight').value);
            
            showLoading();
            
            setTimeout(() => {
                // Create export canvas with specified dimensions
                const exportCanvas = document.createElement('canvas');
                const exportCtx = exportCanvas.getContext('2d');
                exportCanvas.width = width;
                exportCanvas.height = height;
                
                // Draw scaled content
                exportCtx.drawImage(canvas, 0, 0, width, height);
                
                // Export based on format
                let dataURL;
                if (format === 'png') {
                    dataURL = exportCanvas.toDataURL('image/png');
                } else if (format === 'jpg') {
                    dataURL = exportCanvas.toDataURL('image/jpeg', quality);
                } else if (format === 'webp') {
                    dataURL = exportCanvas.toDataURL('image/webp', quality);
                }
                
                // Download
                const link = document.createElement('a');
                link.download = `design_${Date.now()}.${format}`;
                link.href = dataURL;
                link.click();
                
                hideLoading();
                showNotification(`تم تصدير التصميم بصيغة ${format.toUpperCase()}`, 'success');
            }, 1000);
        }

        // Project management
        function saveProject() {
            const projectData = {
                canvas: canvas.toDataURL(),
                layers: layers,
                settings: {
                    textInput: document.getElementById('textInput').value,
                    fontFamily: document.getElementById('fontFamily').value,
                    fontSize: document.getElementById('fontSize').value,
                    primaryColor: document.getElementById('primaryColor').value,
                    secondaryColor: document.getElementById('secondaryColor').value,
                    enableGlow: document.getElementById('enableGlow').checked,
                    glowIntensity: document.getElementById('glowIntensity').value,
                    glowColor: document.getElementById('glowColor').value
                }
            };
            
            const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `project_${Date.now()}.json`;
            link.click();
            
            showNotification('تم حفظ المشروع!', 'success');
        }

        function loadProject() {
            document.getElementById('projectFileInput').click();
        }

        function handleProjectLoad(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const projectData = JSON.parse(e.target.result);
                    
                    // Load canvas
                    const img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                        saveState();
                    };
                    img.src = projectData.canvas;
                    
                    // Load settings
                    const settings = projectData.settings;
                    Object.keys(settings).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) {
                            if (element.type === 'checkbox') {
                                element.checked = settings[key];
                            } else {
                                element.value = settings[key];
                            }
                        }
                    });
                    
                    // Load layers
                    if (projectData.layers) {
                        layers = projectData.layers;
                        updateLayersPanel();
                    }
                    
                    updateDisplay();
                    showNotification('تم تحميل المشروع بنجاح!', 'success');
                } catch (error) {
                    showNotification('خطأ في تحميل المشروع', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            updateProgress(0);
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transform transition-all duration-300 translate-x-full`;
            
            const colors = {
                success: 'bg-green-600 text-white',
                error: 'bg-red-600 text-white',
                info: 'bg-blue-600 text-white',
                warning: 'bg-yellow-600 text-white'
            };
            
            notification.className += ` ${colors[type]}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : type === 'warning' ? 'exclamation' : 'info'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        function showConfirmDialog(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4 border border-gray-600">
                    <p class="text-white mb-4">${message}</p>
                    <div class="flex justify-end space-x-reverse space-x-3">
                        <button class="px-4 py-2 text-gray-400 hover:bg-gray-700 rounded" onclick="this.closest('.fixed').remove()">إلغاء</button>
                        <button class="px-4 py-2 bg-red-600 text-white hover:bg-red-700 rounded" onclick="this.closest('.fixed').remove(); onConfirm()">تأكيد</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            return true;
        }

        // Additional helper functions
        function toggleGrid() {
            // Toggle grid overlay
            showNotification('تم تبديل عرض الشبكة', 'info');
        }

        function toggleRulers() {
            // Toggle rulers
            showNotification('تم تبديل عرض المساطر', 'info');
        }

        function updateColor() {
            if (currentTool === 'text') {
                updateText();
            }
        }

        function updateBrush() {
            // Update brush settings
        }

        function updateOpacity() {
            // Update opacity settings
        }

        function setupCropArea() {
            const cropArea = document.getElementById('cropArea');
            cropArea.style.left = '50px';
            cropArea.style.top = '50px';
            cropArea.style.width = '200px';
            cropArea.style.height = '150px';
        }

        function toggleTextStyle(style) {
            const button = event.target.closest('button');
            button.classList.toggle('active');
            
            // Apply text style
            updateText();
        }

        function addTextShadow() {
            document.getElementById('shadowX').value = 5;
            document.getElementById('shadowY').value = 5;
            document.getElementById('shadowBlur').value = 10;
            updateEffects();
            updateDisplay();
        }

        function exportOptions() {
            showNotification('اختر إعدادات التصدير من اللوحة اليمنى', 'info');
        }
    </script>
</body>
</html>
